rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    // Super Admin check
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.email != null &&
             request.auth.token.email.lower() in [
                'orlando@iyfusa.org',
                'jodlouis.dev@gmail.com',
                'joddev.com@gmail.com',
                'michellemoralespradis@gmail.com',
                'admin@iyforlando.org',
                'director@iyforlando.org'
             ];
    }
    
    // Gmail access check (legacy/broad admin)
    function hasGmailAccess() {
      return request.auth != null && 
             request.auth.token.email.lower().matches('.*@gmail\\.com$');
    }
    
    // Authorized for read-only access to most admin data
    function isAuthorized() {
      return request.auth != null && (isAdmin() || hasGmailAccess());
    }
    
    // Teacher check via index
    function isTeacher() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/teachers_index/$(request.auth.token.email.lower()));
    }
    
    function getTeacherData() {
      return get(/databases/$(database)/documents/teachers_index/$(request.auth.token.email.lower())).data;
    }
    
    // Check if teacher is assigned to this specific academy
    // Expects academyName as used in attendance/progress records
    function isAuthorizedTeacher(academyName) {
      return isTeacher() && (academyName in getTeacherData().authorizedAcademies);
    }

    // --- Collection Rules ---

    // 1. Teachers Index (Admin write, Teacher/Admin read)
    match /teachers_index/{email} {
      allow read: if request.auth != null && (request.auth.token.email.lower() == email.lower() || isAuthorized());
      allow write: if isAdmin();
    }

    // 2. Attendance (Admin full, Teacher scoped write)
    match /academy_attendance/{document} {
      allow read: if isAuthorized() || isTeacher();
      allow create, update: if isAdmin() || isAuthorizedTeacher(request.resource.data.academy);
      allow delete: if isAdmin();
    }

    // 3. Progress (Admin full, Teacher scoped write)
    match /academy_progress/{document} {
      allow read: if isAuthorized() || isTeacher();
      allow create, update: if isAdmin() || isAuthorizedTeacher(request.resource.data.academy);
      allow delete: if isAdmin();
    }

    // 4. Registrations (2026 Spring)
    match /2026-iyf_orlando_academy_spring_semester/{document} {
      allow create: if true; // Public forms
      allow read: if isAuthorized() || isTeacher(); // Teachers can see their students
      allow update, delete: if isAdmin();
    }

    // 5. Academy Config (Public read for forms, Admin write)
    match /academies_2026_spring/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 6. Notifications & Logs (Admin full, Teacher create only)
    match /teacher_notifications/{document} {
      allow read: if isAuthorized();
      allow update, delete: if isAdmin();
      allow create: if isTeacher(); // Teachers log their actions
    }
    match /teacher_activity_log/{document} {
      allow read: if isAuthorized();
      allow create: if isTeacher();
      allow update, delete: if false; // Immutable logs
    }

    // 7. Legacy/Public Collections (Restricting broad access)
    // We only allow CREATE for public forms. READ is restricted.
    match /volunteer_applications/{document} { allow create: if true; allow read, write: if isAuthorized(); }
    match /trip_to_korea_applications/{document} { allow create: if true; allow read, write: if isAuthorized(); }
    match /cooking_class_applications/{document} { allow create: if true; allow read, write: if isAuthorized(); }
    match /kdrama_applications/{document} { allow create: if true; allow read, write: if isAuthorized(); }
    match /volunteer_schedule/{document} { allow read: if true; allow write: if isAdmin(); }
    
    // 8. General Admin Collections
    match /events/{document} { allow read: if true; allow write: if isAdmin(); }
    match /volunteer_hours/{document} { allow read: if isAuthorized(); allow write: if isAdmin(); }
    match /academy_invoices/{document} { allow read: if isAuthorized(); allow write: if isAdmin(); }
    match /2026_spring_academy_invoices_2026/{document} { allow read: if isAuthorized() || isTeacher(); allow write: if isAdmin(); }
    match /academy_payments_2026/{document} { allow read: if isAuthorized() || isTeacher(); allow write: if isAdmin(); }
    match /settings/{document} { allow read: if true; allow write: if isAdmin(); }
    match /email_database/{document} { allow read: if isAuthorized(); allow write: if isAuthorized(); }

    // 9. Teacher Plans
    match /teacher_plans/{document} {
      allow read, write: if isAdmin();
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.teacherEmail.lower() == request.auth.token.email.lower()) &&
        (request.resource == null || request.resource.data.teacherEmail.lower() == request.auth.token.email.lower());
    }

    // --- Final Catch-all ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
