rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.email in [
               'orlando@iyfusa.org',
               'jodlouis.dev@gmail.com'
             ];
    }
    
    // Helper function to check if user has Gmail access
    function hasGmailAccess() {
      return request.auth != null && 
             request.auth.token.email.matches('.*@gmail\\.com$');
    }
    
    // Helper function to check if user is authorized (admin or Gmail)
    function isAuthorized() {
      return request.auth != null && (isAdmin() || hasGmailAccess());
    }
    
    // Allow public read/write access to registration collections (for frontend forms)
    match /fall_academy_2025/{document} {
      allow read, write: if true;
    }
    
    // Allow public read/write access to volunteer applications (for frontend forms)
    match /volunteer_applications/{document} {
      allow read, write: if true;
    }
    
    // Allow public read/write access to trip to korea applications (for frontend forms)
    match /trip_to_korea_applications/{document} {
      allow read, write: if true;
    }
    
    // Allow public read/write access to cooking class applications (for frontend forms)
    match /cooking_class_applications/{document} {
      allow read, write: if true;
    }
    
    // Allow public read/write access to kdrama applications (for frontend forms)
    match /kdrama_applications/{document} {
      allow read, write: if true;
    }
    
    // Allow public read/write access to volunteer schedule (for frontend forms)
    match /volunteer_schedule/{document} {
      allow read, write: if true;
    }
    
    // Events collection - admins have full access, others read-only
    match /events/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Volunteer hours collection - admins have full access, others read-only
    match /volunteer_hours/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Volunteer codes collection - admins have full access, others read-only
    match /volunteer_codes/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Settings collection - admins have full access, others read-only
    match /settings/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Academy invoices collection - admins have full access, others read-only
    match /academy_invoices/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Academy payments collection - admins have full access, others read-only
    match /academy_payments/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Academy attendance collection - admins have full access, others read-only
    match /academy_attendance/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Academy progress collection - admins have full access, others read-only
    match /academy_progress/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Academy classes collection - admins have full access, others read-only
    match /academy_classes/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Academy pricing collection - admins have full access, others read-only
    match /academy_pricing/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Food tickets collection - admins have full access, others read-only
    match /food_tickets/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Weekly reports collection - admins have full access, others read-only
    match /weekly_reports/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Teachers collection - admins have full access, others read-only
    match /teachers/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Email database collection - public read, admin write
    match /email_database/{document} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Eventbrite emails collection - public read, admin write
    match /eventbrite_emails/{document} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Registrations collection - public read access for email import
    match /registrations/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Staff collection - public read access for email import
    match /staff/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Staff profiles collection - public read access for email import
    match /staff_profiles/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Teachers collection - public read access for email import
    match /teachers/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Payments collection - public read access for email import
    match /payments/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Spring academy collection - public read access for email import
    match /spring_academy_2025/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // K-drama registration collection - public read access for email import
    match /k_drama_with_friends_registration/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Trip to korea registration collection - public read access for email import
    match /trip_to_korea_registration/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Subscribers collection - public read access for email import
    match /subscribers/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Allow public read/write access to any future registration collections (for frontend forms)
    match /{collection}/{document} {
      allow read, write: if 
        collection.matches('.*academy.*') || 
        collection.matches('.*registration.*') || 
        collection.matches('.*volunteer.*') ||
        collection.matches('.*trip.*') ||
        collection.matches('.*cooking.*') ||
        collection.matches('.*kdrama.*') ||
        collection.matches('.*application.*');
    }
    
    // Default rule - deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
